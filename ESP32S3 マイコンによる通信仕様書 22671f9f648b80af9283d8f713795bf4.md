# ESP32S3 マイコンによる通信仕様書

**現在のプロジェクトで一貫して使われている通信仕様・GPIO割り当て・定数マクロ定義**をまとめた「最新版・通信仕様書（2025年7月2日現在）」として記録しておきます。

---

## 📘 NTC-1A 通信仕様書（2025年7月2日更新）

### 🧩 機器構成

- **Raspberry Pi（メイン）**
- **ESP32-S3（中継器/リピーター）**
- **ESP32-S3（TCエミュレーター）※旧：Arduino Nano Every**
- **Grove Shield for Seeeduino XIAO v1.0**

### 🎮 ピン定義（スケッチ内定義）

```c
#define TC_UART_TX_PIN 2    // BitBang送信用 (→TC RX)
#define TC_UART_RX_PIN 3    // BitBang受信用 (←TC TX)
#define PI_UART_TX_PIN 43   // UART送信（→ Pi）
#define PI_UART_RX_PIN 44   // UART受信（← Pi）
#define LOG_MODE_PIN 10     // ログ詳細スイッチ（LOW時に詳細）
#define TEST_PIN 8          // テスト送信モード（HIGHでON）
#define LED_PIN 21          // 動作表示用LED
```

### 🧷 Groveポート割当（上から基板を見た図に基づく）

| ポート名 | 接続対象 | GPIO | 接続種別 | 備考 |
| --- | --- | --- | --- | --- |
| **J2** | TC（BitBang） | TX: GPIO2RX: GPIO3 | 300bps ビットバンギング | **要クロス接続** |
| **J5** | OLED | SDA: GPIO4SCL: GPIO5 | I2C | SSD1306 |
| **J6** | Raspberry Pi | TX: GPIO43RX: GPIO44 | UART（115200bps） | TCエミュレーターでは使用しない場合あり |

---

### 📡 UART通信仕様（Raspberry Pi ↔ ESP32リピーター）

| 項目 | 内容 |  |
| --- | --- | --- |
| 通信方式 | UART（ハードウェア） |  |
| ボーレート | `9600bps`（※定義済みマクロ使用） |  |
| TXピン（ESP32） | GPIO **43**（→ Pi RX） |  |
| RXピン（ESP32） | GPIO **44**（← Pi TX） |  |
| 備考 | Groveポート **J6** で運用 |  |
| マクロ定義例 | `#define UART_BAUDRATE 9600
#define PI_UART_TX_PIN 43
#define PI_UART_RX_PIN 44` |  |

---

### 🌀 BitBang通信仕様（ESP32 ↔ TC）

| 項目 | 内容 |
| --- | --- |
| 通信方式 | ソフトウェアビットバンギング（LSB先送） |
| ボーレート | 300bps |
| TXピン（ESP32） | GPIO **2**（→ TC RX） |
| RXピン（ESP32） | GPIO **3**（← TC TX） |
| 備考 | Groveポート **J2** を使用（※クロス接続必要） |
| マクロ定義例 | `#define TC_UART_TX_PIN 2
#define TC_UART_RX_PIN 3` |

📌 **※注意：BitBang接続はTX ↔ RXのクロス結線が必須です。**

---

### 📺 OLED表示用（共通）

| 項目 | 内容 |
| --- | --- |
| I2C SDA | GPIO **4** |
| I2C SCL | GPIO **5** |
| Groveポート | J5 |

---

### 💡 MACアドレス一覧（現行）

| 用途 | MACアドレス | 備考 |
| --- | --- | --- |
| リピーター | `8C:BF:EA:8E:57:F4` | 現在稼働中 |
| 旧エミュレーター | `98:3D:AE:60:55:1C` | 故障機（使用不可） |

---

### ✅ 追加メモ（記録）

- **通信速度の切り替え**は `#define UART_BAUDRATE` にて柔軟に変更可能。

- BitBangはクロック精度が必要なため、ESP32-S3のタイマーとFreeRTOSを併用。

- OLEDログは、**上段：送信パケット／下段：受信パケット**で分離表示。

- モードごとの点滅動作やログ出力は、全モードで共通性を保つ設計方針。

  Grove Shield for Seeeduino XIAO v1.0 基板図面あり

  

---

この仕様は、将来のメンテナンスや引き継ぎ・機器交換の際にも重要になるため、

`/docs/通信仕様_2025.md` のような形式でリポジトリにも置くと安心です。

今後の構成変更にも対応しますので、安心してご相談ください！